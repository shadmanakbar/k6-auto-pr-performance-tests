name: k6 Performance Tests (MCP Powered)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  k6-mcp-test:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_BODY: ${{ github.event.pull_request.body }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      REPO: ${{ github.repository }}
      OLLAMA_HOST: http://localhost:11434

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Detect tech stack
        id: detect-stack
        run: |
          STACK="unknown"
          if [ -f "pom.xml" ]; then STACK="java-maven"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then STACK="java-gradle"
          elif [ -f "package.json" ]; then STACK="node"
          elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then STACK="python"
          elif [ -f "go.mod" ]; then STACK="go"
          elif [ -f "Gemfile" ]; then STACK="ruby"
          fi
          echo "stack=$STACK" >> "$GITHUB_OUTPUT"

      # --- Setup Runtimes ---
      - name: Setup Java
        if: contains(steps.detect-stack.outputs.stack, 'java')
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Node.js (for MCP Server)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # --- Build App ---
      - name: Build App
        run: |
          STACK="${{ steps.detect-stack.outputs.stack }}"
          if [ "$STACK" == "java-maven" ]; then mvn -B package -DskipTests
          elif [ "$STACK" == "node" ]; then npm install && (npm run build || true)
          fi

      # --- Start App ---
      - name: Start application
        run: |
          chmod +x scripts/start.sh
          bash scripts/start.sh &
          sleep 10 # Basic wait, MCP server can handle health checks if needed

      # --- Install K6 & Ollama (MCP Tools dependencies) ---
      - name: Install dependencies
        run: |
          # Install k6
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update -qq && sudo apt-get install -y k6
          
          # Install Ollama
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5
          ollama pull llama3

      # --- Prepare MCP Server ---
      - name: Prepare MCP Server
        run: |
          cd mcp-server
          npm install
          npm run build

      # --- Execute MCP Orchestrator ---
      - name: Run K6 MCP Orchestrator
        env:
          DETECTED_STACK: ${{ steps.detect-stack.outputs.stack }}
        run: |
          python3 scripts/mcp_orchestrator.py
