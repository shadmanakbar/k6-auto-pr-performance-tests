name: k6 Performance Tests (Pure MCP)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  k6-performance-test:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Detect tech stack
        id: detect-stack
        run: |
          STACK="unknown"
          if [ -f "pom.xml" ]; then STACK="java-maven"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then STACK="java-gradle"
          elif [ -f "package.json" ]; then STACK="node"
          fi
          echo "stack=$STACK" >> "$GITHUB_OUTPUT"

      - name: Setup Java
        if: contains(steps.detect-stack.outputs.stack, 'java')
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Environment
        run: |
          # Install k6 from official repo
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update -qq && sudo apt-get install -y k6
          
          # Install Official mcp-k6
          VERSION="0.5.0"
          curl -LO "https://github.com/grafana/mcp-k6/releases/download/v${VERSION}/mcp-k6_${VERSION}_linux_amd64.deb"
          sudo apt install ./mcp-k6_${VERSION}_linux_amd64.deb
          
          # Install Ollama
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5 && ollama pull llama3

      - name: Build App
        run: |
          STACK="${{ steps.detect-stack.outputs.stack }}"
          if [ "$STACK" == "java-maven" ]; then mvn -B package -DskipTests
          elif [ "$STACK" == "node" ]; then npm install && (npm run build || true)
          fi

      - name: Start App
        run: |
          chmod +x scripts/start.sh
          ./scripts/start.sh &
          sleep 20

      - name: Run K6 via Pure MCP (Stdio)
        id: run-mcp
        run: |
          echo "ü§ñ Handshaking and calling mcp-k6 via Pure JSON-RPC over Stdio..."
          
          # We send INITIALIZE, then TOOL/CALL
          # This is the standard MCP protocol without any custom scripts.
          
          cat <<EOF > mcp_input.jsonl
          {"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"github-action","version":"1.0"}}}
          {"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"run_script","arguments":{"script":"import http from 'k6/http'; export default () => { http.get('http://localhost:8080/'); }","vus":10,"duration":"10s"}}}
          EOF
          
          # Run the server and capture the output
          # We use a 40s timeout because k6 runs for 10s + overhead
          RESULT=$(cat mcp_input.jsonl | mcp-k6 2>/dev/null | grep '"id":2' || true)
          
          echo "üìä MCP Response: $RESULT"
          
          if [ -z "$RESULT" ]; then
             echo "‚ùå MCP Server failed to respond to tool call"
             exit 1
          fi
          
          if echo "$RESULT" | grep -q '"isError":true'; then
             echo "‚ùå Performance test execution reported an error"
             exit 1
          fi
          
          echo "‚úÖ Performance test completed successfully via Pure MCP"
