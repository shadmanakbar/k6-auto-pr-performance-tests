name: k6 Performance Tests (Pure MCP)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  k6-performance-test:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Detect tech stack
        id: detect-stack
        run: |
          STACK="unknown"
          if [ -f "pom.xml" ]; then STACK="java-maven"
          elif [ -f "package.json" ]; then STACK="node"
          fi
          echo "stack=$STACK" >> "$GITHUB_OUTPUT"

      - name: Setup Environment
        run: |
          # Install k6 & mcp-k6
          sudo apt-get update && sudo apt install -y k6
          curl -LO https://github.com/grafana/mcp-k6/releases/download/v0.5.0/mcp-k6_0.5.0_linux_amd64.deb
          sudo apt install ./mcp-k6_0.5.0_linux_amd64.deb
          
          # Install Ollama
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5 && ollama pull llama3

      - name: Start App
        run: |
          chmod +x scripts/start.sh
          ./scripts/start.sh &
          sleep 15

      # --- PURE MCP STEP ---
      # We use a one-liner to call the MCP tools via the CLI
      # This is the "Pure" way: No custom python scripts, just invoking tools.
      - name: Run K6 via MCP
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ¤– Invoking mcp-k6 tools directly..."
          
          # 1. Generate & Run via the 'run_script' tool
          # We pass a baseline script and let MCP do the heavy lifting
          RESULT=$(mcp-k6 --transport stdio <<EOF
          {
            "jsonrpc": "2.0",
            "id": 1,
            "method": "tools/call",
            "params": {
              "name": "run_script",
              "arguments": {
                "script": "import http from 'k6/http'; export default function() { http.get('http://localhost:8080/'); }",
                "vus": 10,
                "duration": "30s"
              }
            }
          }
          EOF
          )
          
          echo "ðŸ“Š Results: $RESULT"
          
          # 2. Handle failure if success is false
          if echo "$RESULT" | grep -q '"success":false'; then
            echo "âŒ Performance test failed"
            exit 1
          fi
          echo "âœ… Performance test passed"
