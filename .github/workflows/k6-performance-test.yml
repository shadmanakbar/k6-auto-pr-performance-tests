name: k6 Performance Tests (HTTP MCP)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  k6-performance-test:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          # Install k6 from official repo
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update -qq && sudo apt-get install -y k6
          
          # Install Official mcp-k6
          VERSION="0.5.0"
          curl -LO "https://github.com/grafana/mcp-k6/releases/download/v${VERSION}/mcp-k6_${VERSION}_linux_amd64.deb"
          sudo apt install ./mcp-k6_${VERSION}_linux_amd64.deb
          
          # Install Ollama
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5 && ollama pull llama3

      - name: Start App
        run: |
          chmod +x scripts/start.sh
          ./scripts/start.sh &
          sleep 15

      - name: Start MCP Server (HTTP Mode)
        run: |
          mcp-k6 -transport=http -addr=:8081 &
          echo "‚è≥ Waiting for MCP HTTP server..."
          for i in {1..30}; do
            if curl -s http://localhost:8081/ > /dev/null; then
              echo "‚úÖ MCP Server ready"
              break
            fi
            sleep 1
          done

      - name: Run K6 via HTTP MCP
        id: run-mcp
        run: |
          echo "ü§ñ Calling mcp-k6 run_script tool via curl..."
          
          # Note: MCP HTTP transport usually uses POST to /mcp or similar
          # As per README: -endpoint (default /mcp)
          
          RESPONSE=$(curl -s -X POST http://localhost:8081/mcp \
            -H "Content-Type: application/json" \
            -d '{
              "jsonrpc": "2.0",
              "id": 1,
              "method": "tools/call",
              "params": {
                "name": "run_script",
                "arguments": {
                  "script": "import http from \"k6/http\"; export default function() { http.get(\"http://localhost:8080/\"); }",
                  "vus": 10,
                  "duration": "10s"
                }
              }
            }')
          
          echo "üìä MCP Response: $RESPONSE"
          
          # Extract metrics and report (minimal check for success)
          if echo "$RESPONSE" | grep -q '"success":true'; then
             echo "‚úÖ Test Passed"
          else
             echo "‚ùå Test Failed or Error in MCP"
             exit 1
          fi
